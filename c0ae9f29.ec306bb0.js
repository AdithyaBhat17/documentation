(window.webpackJsonp=window.webpackJsonp||[]).push([[253],{330:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return o})),n.d(t,"metadata",(function(){return l})),n.d(t,"toc",(function(){return c})),n.d(t,"default",(function(){return p}));var i=n(3),a=n(7),r=(n(0),n(411)),o={title:"Migrating to Version 3"},l={unversionedId:"guides/migration/v3",id:"guides/migration/v3",isDocsHomePage:!1,title:"Migrating to Version 3",description:"Benthos version 3 comes with some breaking service and configuration changes as well as a few breaking API changes.",source:"@site/docs/guides/migration/v3.md",slug:"/guides/migration/v3",permalink:"/docs/guides/migration/v3",editUrl:"https://github.com/Jeffail/benthos/edit/master/website/docs/guides/migration/v3.md",version:"current",sidebar:"docs",previous:{title:"Migrating to Version 2",permalink:"/docs/guides/migration/v2"}},c=[{value:"Service",id:"service",children:[{value:"Memory Map File Buffer Removed",id:"memory-map-file-buffer-removed",children:[]},{value:"Old Metrics Paths Removed",id:"old-metrics-paths-removed",children:[]},{value:"Metric Path Changes",id:"metric-path-changes",children:[]}]},{value:"Configuration",id:"configuration",children:[{value:"Metrics Prefix",id:"metrics-prefix",children:[]},{value:"JSON Paths",id:"json-paths",children:[]},{value:"Process DAG Stage Names",id:"process-dag-stage-names",children:[]}]},{value:"Go API",id:"go-api",children:[{value:"Modules",id:"modules",children:[]},{value:"Other",id:"other",children:[]}]}],b={toc:c};function p(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(r.b)("wrapper",Object(i.a)({},b,n,{components:t,mdxType:"MDXLayout"}),Object(r.b)("p",null,"Benthos version 3 comes with some breaking ",Object(r.b)("a",Object(i.a)({parentName:"p"},{href:"#service"}),"service")," and ",Object(r.b)("a",Object(i.a)({parentName:"p"},{href:"#configuration"}),"configuration")," changes as well as a few breaking ",Object(r.b)("a",Object(i.a)({parentName:"p"},{href:"#go-api"}),"API changes"),"."),Object(r.b)("h2",{id:"service"},"Service"),Object(r.b)("h3",{id:"memory-map-file-buffer-removed"},"Memory Map File Buffer Removed"),Object(r.b)("p",null,"The long deprecated ",Object(r.b)("inlineCode",{parentName:"p"},"mmap_file")," buffer has been removed. If you were still relying on this buffer implementation then please ",Object(r.b)("a",Object(i.a)({parentName:"p"},{href:"https://github.com/Jeffail/benthos/issues"}),"raise an issue"),"."),Object(r.b)("h3",{id:"old-metrics-paths-removed"},"Old Metrics Paths Removed"),Object(r.b)("p",null,"The following undocumented metrics paths have been removed:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"input.parts.count")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"input.read.success")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"input.read.error")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"input.send.success")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"input.send.error")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"input.ack.success")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"input.ack.error")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"output.running")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"output.parts.count")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"output.send.success")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"output.parts.send.success")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"output.send.error"))),Object(r.b)("p",null,"All of these paths have ",Object(r.b)("a",Object(i.a)({parentName:"p"},{href:"/docs/components/metrics/about#paths"}),"remaining equivalents"),"."),Object(r.b)("h3",{id:"metric-path-changes"},"Metric Path Changes"),Object(r.b)("p",null,"The ",Object(r.b)("inlineCode",{parentName:"p"},"http_client")," output client metrics have been renamed from ",Object(r.b)("inlineCode",{parentName:"p"},"output.*.output.http_client")," to ",Object(r.b)("inlineCode",{parentName:"p"},"output.*.client"),"."),Object(r.b)("h2",{id:"configuration"},"Configuration"),Object(r.b)("h3",{id:"metrics-prefix"},"Metrics Prefix"),Object(r.b)("p",null,"The configuration field ",Object(r.b)("inlineCode",{parentName:"p"},"prefix")," within ",Object(r.b)("inlineCode",{parentName:"p"},"metrics")," has been moved from the root\nof the config object to individual types. E.g. when using ",Object(r.b)("inlineCode",{parentName:"p"},"statsd")," the field\n",Object(r.b)("inlineCode",{parentName:"p"},"metrics.prefix")," should be replaced with ",Object(r.b)("inlineCode",{parentName:"p"},"metrics.statsd.prefix"),"."),Object(r.b)("h3",{id:"json-paths"},"JSON Paths"),Object(r.b)("p",null,'Many components within Benthos use an unspecified "JSON dot path" syntax for querying and setting fields within JSON documents. The format of these paths has been formalised to make them clearer and more generally useful, but this potentially breaks your paths when they query against hierarchies that contain arrays.'),Object(r.b)("p",null,"The formal specification for v3 can be found ",Object(r.b)("a",Object(i.a)({parentName:"p"},{href:"/docs/configuration/field_paths"}),"in this document"),"."),Object(r.b)("p",null,"The following components are affected:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"awk")," processor (all of the ",Object(r.b)("inlineCode",{parentName:"li"},"json_*")," functions)"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"json")," processor (",Object(r.b)("inlineCode",{parentName:"li"},"path")," field)"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"process_field")," processor (",Object(r.b)("inlineCode",{parentName:"li"},"path")," field)"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"process_map")," processor (",Object(r.b)("inlineCode",{parentName:"li"},"premap"),", ",Object(r.b)("inlineCode",{parentName:"li"},"premap_optional"),", ",Object(r.b)("inlineCode",{parentName:"li"},"postmap")," and ",Object(r.b)("inlineCode",{parentName:"li"},"postmap_optional")," fields)"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"check_field")," condition (",Object(r.b)("inlineCode",{parentName:"li"},"path")," field)"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"json_field")," function interpolation"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"s3")," input (",Object(r.b)("inlineCode",{parentName:"li"},"sqs_body_path"),", ",Object(r.b)("inlineCode",{parentName:"li"},"sqs_bucket_path")," and ",Object(r.b)("inlineCode",{parentName:"li"},"sqs_envelope_path")," fields)"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"dynamodb")," output (",Object(r.b)("inlineCode",{parentName:"li"},"json_map_columns")," field values)")),Object(r.b)("h4",{id:"migration-guide"},"Migration Guide"),Object(r.b)("p",null,"In order to replicate the exact same behaviour as currently exists your paths should be updated to include the character ",Object(r.b)("inlineCode",{parentName:"p"},"*")," wherever an array exists. For example, the default value of ",Object(r.b)("inlineCode",{parentName:"p"},"sqs_body_path")," for the ",Object(r.b)("inlineCode",{parentName:"p"},"s3")," input has been updated from ",Object(r.b)("inlineCode",{parentName:"p"},"Records.s3.object.key")," to ",Object(r.b)("inlineCode",{parentName:"p"},"Records.*.s3.object.key"),"."),Object(r.b)("h3",{id:"process-dag-stage-names"},"Process DAG Stage Names"),Object(r.b)("p",null,"The ",Object(r.b)("inlineCode",{parentName:"p"},"process_dag")," processor now only permits workflow stage names matching the following regular expression: ",Object(r.b)("inlineCode",{parentName:"p"},"[a-zA-Z0-9_-]+"),". The reasoning for this restriction is to potentially expand the features of ",Object(r.b)("inlineCode",{parentName:"p"},"process_dag")," in the future with custom root fields (e.g. ",Object(r.b)("inlineCode",{parentName:"p"},"$on_error"),")."),Object(r.b)("h2",{id:"go-api"},"Go API"),Object(r.b)("h3",{id:"modules"},"Modules"),Object(r.b)("p",null,"Benthos now fully adheres to ",Object(r.b)("a",Object(i.a)({parentName:"p"},{href:"https://github.com/golang/go/wiki/Modules"}),"Go Modules"),", import paths must therefore now contain the major version (v3) like so:"),Object(r.b)("pre",null,Object(r.b)("code",Object(i.a)({parentName:"pre"},{className:"language-go"}),'import "github.com/Jeffail/benthos/v3/lib/processor"\n')),Object(r.b)("p",null,"It should be pretty quick to update your imports, either using a tool or just:"),Object(r.b)("pre",null,Object(r.b)("code",Object(i.a)({parentName:"pre"},{className:"language-sh"}),'grep "Jeffail/benthos" . -Rl | grep -e "\\.go$" | xargs -I{} sed -i \'s/Jeffail\\/benthos/Jeffail\\/benthos\\/v3/g\' {}\n')),Object(r.b)("h3",{id:"other"},"Other"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"Constructors for buffer components now require a ",Object(r.b)("inlineCode",{parentName:"li"},"types.Manager"),", giving them parity with other components: ",Object(r.b)("inlineCode",{parentName:"li"},"buffer.New(conf Config, mgr types.Manager, log log.Modular, stats metrics.Type) (Type, error)"))))}p.isMDXComponent=!0},411:function(e,t,n){"use strict";n.d(t,"a",(function(){return s})),n.d(t,"b",(function(){return m}));var i=n(0),a=n.n(i);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,i,a=function(e,t){if(null==e)return{};var n,i,a={},r=Object.keys(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var b=a.a.createContext({}),p=function(e){var t=a.a.useContext(b),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},s=function(e){var t=p(e.components);return a.a.createElement(b.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},d=a.a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,o=e.parentName,b=c(e,["components","mdxType","originalType","parentName"]),s=p(n),d=i,m=s["".concat(o,".").concat(d)]||s[d]||u[d]||r;return n?a.a.createElement(m,l(l({ref:t},b),{},{components:n})):a.a.createElement(m,l({ref:t},b))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=d;var l={};for(var c in t)hasOwnProperty.call(t,c)&&(l[c]=t[c]);l.originalType=e,l.mdxType="string"==typeof e?e:i,o[1]=l;for(var b=2;b<r;b++)o[b]=n[b];return a.a.createElement.apply(null,o)}return a.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"}}]);