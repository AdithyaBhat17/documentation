(window.webpackJsonp=window.webpackJsonp||[]).push([[309],{386:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return s})),n.d(t,"metadata",(function(){return l})),n.d(t,"toc",(function(){return p})),n.d(t,"default",(function(){return b}));var a=n(3),r=n(7),o=(n(0),n(411)),c=n(415),i=n(416),s={title:"dedupe",type:"processor",status:"stable",categories:["Utility"]},l={unversionedId:"components/processors/dedupe",id:"components/processors/dedupe",isDocsHomePage:!1,title:"dedupe",description:"\x3c!--",source:"@site/docs/components/processors/dedupe.md",slug:"/components/processors/dedupe",permalink:"/docs/components/processors/dedupe",editUrl:"https://github.com/Jeffail/benthos/edit/master/website/docs/components/processors/dedupe.md",version:"current",sidebar:"docs",previous:{title:"decompress",permalink:"/docs/components/processors/decompress"},next:{title:"for_each",permalink:"/docs/components/processors/for_each"}},p=[{value:"Delivery Guarantees",id:"delivery-guarantees",children:[]},{value:"Fields",id:"fields",children:[{value:"<code>cache</code>",id:"cache",children:[]},{value:"<code>hash</code>",id:"hash",children:[]},{value:"<code>key</code>",id:"key",children:[]},{value:"<code>drop_on_err</code>",id:"drop_on_err",children:[]},{value:"<code>parts</code>",id:"parts",children:[]}]}],u={toc:p};function b(e){var t=e.components,n=Object(r.a)(e,["components"]);return Object(o.b)("wrapper",Object(a.a)({},u,n,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,"Deduplicates message batches by caching selected (and optionally hashed)\nmessages, dropping batches that are already cached."),Object(o.b)(c.a,{defaultValue:"common",values:[{label:"Common",value:"common"},{label:"Advanced",value:"advanced"}],mdxType:"Tabs"},Object(o.b)(i.a,{value:"common",mdxType:"TabItem"},Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-yaml"}),'# Common config fields, showing default values\ndedupe:\n  cache: ""\n  hash: none\n  key: ""\n  drop_on_err: true\n'))),Object(o.b)(i.a,{value:"advanced",mdxType:"TabItem"},Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-yaml"}),'# All config fields, showing default values\ndedupe:\n  cache: ""\n  hash: none\n  key: ""\n  drop_on_err: true\n  parts:\n    - 0\n')))),Object(o.b)("p",null,"This processor acts across an entire batch, in order to deduplicate individual\nmessages within a batch use this processor with the\n",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"/docs/components/processors/for_each"}),Object(o.b)("inlineCode",{parentName:"a"},"for_each"))," processor."),Object(o.b)("p",null,"Optionally, the ",Object(o.b)("inlineCode",{parentName:"p"},"key")," field can be populated in order to hash on a\nfunction interpolated string rather than the full contents of messages. This\nallows you to deduplicate based on dynamic fields within a message, such as its\nmetadata, JSON fields, etc. A full list of interpolation functions can be found\n",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"/docs/configuration/interpolation#bloblang-queries"}),"here"),"."),Object(o.b)("p",null,"For example, the following config would deduplicate based on the concatenated\nvalues of the metadata field ",Object(o.b)("inlineCode",{parentName:"p"},"kafka_key")," and the value of the JSON\npath ",Object(o.b)("inlineCode",{parentName:"p"},"id")," within the message contents:"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-yaml"}),'pipeline:\n  processors:\n    - dedupe:\n        cache: foocache\n        key: ${! meta("kafka_key") }-${! json("id") }\n')),Object(o.b)("p",null,"Caches should be configured as a resource, for more information check out the\n",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"/docs/components/caches/about"}),"documentation here"),"."),Object(o.b)("p",null,"When using this processor with an output target that might fail you should\nalways wrap the output within a ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"/docs/components/outputs/retry"}),Object(o.b)("inlineCode",{parentName:"a"},"retry")),"\nblock. This ensures that during outages your messages aren't reprocessed after\nfailures, which would result in messages being dropped."),Object(o.b)("h2",{id:"delivery-guarantees"},"Delivery Guarantees"),Object(o.b)("p",null,"Performing deduplication on a stream using a distributed cache voids any\nat-least-once guarantees that it previously had. This is because the cache will\npreserve message signatures even if the message fails to leave the Benthos\npipeline, which would cause message loss in the event of an outage at the output\nsink followed by a restart of the Benthos instance."),Object(o.b)("p",null,"If you intend to preserve at-least-once delivery guarantees you can avoid this\nproblem by using a memory based cache. This is a compromise that can achieve\neffective deduplication but parallel deployments of the pipeline as well as\nservice restarts increase the chances of duplicates passing undetected."),Object(o.b)("h2",{id:"fields"},"Fields"),Object(o.b)("h3",{id:"cache"},Object(o.b)("inlineCode",{parentName:"h3"},"cache")),Object(o.b)("p",null,"The ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"/docs/components/caches/about"}),Object(o.b)("inlineCode",{parentName:"a"},"cache")," resource")," to target with this processor."),Object(o.b)("p",null,"Type: ",Object(o.b)("inlineCode",{parentName:"p"},"string"),Object(o.b)("br",{parentName:"p"}),"\n","Default: ",Object(o.b)("inlineCode",{parentName:"p"},'""'),"  "),Object(o.b)("h3",{id:"hash"},Object(o.b)("inlineCode",{parentName:"h3"},"hash")),Object(o.b)("p",null,"The hash type to used."),Object(o.b)("p",null,"Type: ",Object(o.b)("inlineCode",{parentName:"p"},"string"),Object(o.b)("br",{parentName:"p"}),"\n","Default: ",Object(o.b)("inlineCode",{parentName:"p"},'"none"'),Object(o.b)("br",{parentName:"p"}),"\n","Options: ",Object(o.b)("inlineCode",{parentName:"p"},"none"),", ",Object(o.b)("inlineCode",{parentName:"p"},"xxhash"),"."),Object(o.b)("h3",{id:"key"},Object(o.b)("inlineCode",{parentName:"h3"},"key")),Object(o.b)("p",null,"An optional key to use for deduplication (instead of the entire message contents).\nThis field supports ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"/docs/configuration/interpolation#bloblang-queries"}),"interpolation functions"),"."),Object(o.b)("p",null,"Type: ",Object(o.b)("inlineCode",{parentName:"p"},"string"),Object(o.b)("br",{parentName:"p"}),"\n","Default: ",Object(o.b)("inlineCode",{parentName:"p"},'""'),"  "),Object(o.b)("h3",{id:"drop_on_err"},Object(o.b)("inlineCode",{parentName:"h3"},"drop_on_err")),Object(o.b)("p",null,"Whether messages should be dropped when the cache returns an error."),Object(o.b)("p",null,"Type: ",Object(o.b)("inlineCode",{parentName:"p"},"bool"),Object(o.b)("br",{parentName:"p"}),"\n","Default: ",Object(o.b)("inlineCode",{parentName:"p"},"true"),"  "),Object(o.b)("h3",{id:"parts"},Object(o.b)("inlineCode",{parentName:"h3"},"parts")),Object(o.b)("p",null,"An array of message indexes within the batch to deduplicate based on. If left empty all messages included. This field is only applicable when batching messages ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"/docs/configuration/batching"}),"at the input level"),"."),Object(o.b)("p",null,"Type: ",Object(o.b)("inlineCode",{parentName:"p"},"array"),Object(o.b)("br",{parentName:"p"}),"\n","Default: ",Object(o.b)("inlineCode",{parentName:"p"},"[0]"),"  "))}b.isMDXComponent=!0},411:function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return h}));var a=n(0),r=n.n(a);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?c(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):c(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=r.a.createContext({}),p=function(e){var t=r.a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=p(e.components);return r.a.createElement(l.Provider,{value:t},e.children)},b={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},d=r.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,c=e.parentName,l=s(e,["components","mdxType","originalType","parentName"]),u=p(n),d=a,h=u["".concat(c,".").concat(d)]||u[d]||b[d]||o;return n?r.a.createElement(h,i(i({ref:t},l),{},{components:n})):r.a.createElement(h,i({ref:t},l))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,c=new Array(o);c[0]=d;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:a,c[1]=i;for(var l=2;l<o;l++)c[l]=n[l];return r.a.createElement.apply(null,c)}return r.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},412:function(e,t,n){"use strict";function a(e){var t,n,r="";if("string"==typeof e||"number"==typeof e)r+=e;else if("object"==typeof e)if(Array.isArray(e))for(t=0;t<e.length;t++)e[t]&&(n=a(e[t]))&&(r&&(r+=" "),r+=n);else for(t in e)e[t]&&(r&&(r+=" "),r+=t);return r}t.a=function(){for(var e,t,n=0,r="";n<arguments.length;)(e=arguments[n++])&&(t=a(e))&&(r&&(r+=" "),r+=t);return r}},413:function(e,t,n){"use strict";var a=n(0),r=n(414);t.a=function(){var e=Object(a.useContext)(r.a);if(null==e)throw new Error("`useUserPreferencesContext` is used outside of `Layout` Component.");return e}},414:function(e,t,n){"use strict";var a=n(0),r=Object(a.createContext)(void 0);t.a=r},415:function(e,t,n){"use strict";var a=n(0),r=n.n(a),o=n(413),c=n(412),i=n(56),s=n.n(i),l=37,p=39;t.a=function(e){var t=e.lazy,n=e.block,i=e.defaultValue,u=e.values,b=e.groupId,d=e.className,h=Object(o.a)(),m=h.tabGroupChoices,f=h.setTabGroupChoices,O=Object(a.useState)(i),j=O[0],y=O[1],g=a.Children.toArray(e.children);if(null!=b){var v=m[b];null!=v&&v!==j&&u.some((function(e){return e.value===v}))&&y(v)}var N=function(e){y(e),null!=b&&f(b,e)},w=[];return r.a.createElement("div",null,r.a.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:Object(c.a)("tabs",{"tabs--block":n},d)},u.map((function(e){var t=e.value,n=e.label;return r.a.createElement("li",{role:"tab",tabIndex:0,"aria-selected":j===t,className:Object(c.a)("tabs__item",s.a.tabItem,{"tabs__item--active":j===t}),key:t,ref:function(e){return w.push(e)},onKeyDown:function(e){!function(e,t,n){switch(n.keyCode){case p:!function(e,t){var n=e.indexOf(t)+1;e[n]?e[n].focus():e[0].focus()}(e,t);break;case l:!function(e,t){var n=e.indexOf(t)-1;e[n]?e[n].focus():e[e.length-1].focus()}(e,t)}}(w,e.target,e)},onFocus:function(){return N(t)},onClick:function(){N(t)}},n)}))),t?Object(a.cloneElement)(g.filter((function(e){return e.props.value===j}))[0],{className:"margin-vert--md"}):r.a.createElement("div",{className:"margin-vert--md"},g.map((function(e,t){return Object(a.cloneElement)(e,{key:t,hidden:e.props.value!==j})}))))}},416:function(e,t,n){"use strict";var a=n(3),r=n(0),o=n.n(r);t.a=function(e){var t=e.children,n=e.hidden,r=e.className;return o.a.createElement("div",Object(a.a)({role:"tabpanel"},{hidden:n,className:r}),t)}}}]);