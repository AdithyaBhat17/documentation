(window.webpackJsonp=window.webpackJsonp||[]).push([[291],{368:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return c})),n.d(t,"metadata",(function(){return l})),n.d(t,"toc",(function(){return p})),n.d(t,"default",(function(){return b}));var a=n(3),r=n(7),o=(n(0),n(411)),s=n(415),i=n(416),c={title:"branch",type:"processor",status:"beta",categories:["Composition"]},l={unversionedId:"components/processors/branch",id:"components/processors/branch",isDocsHomePage:!1,title:"branch",description:"\x3c!--",source:"@site/docs/components/processors/branch.md",slug:"/components/processors/branch",permalink:"/docs/components/processors/branch",editUrl:"https://github.com/Jeffail/benthos/edit/master/website/docs/components/processors/branch.md",version:"current",sidebar:"docs",previous:{title:"bounds_check",permalink:"/docs/components/processors/bounds_check"},next:{title:"cache",permalink:"/docs/components/processors/cache"}},p=[{value:"Metadata",id:"metadata",children:[]},{value:"Error Handling",id:"error-handling",children:[]},{value:"Conditional Branching",id:"conditional-branching",children:[]},{value:"Fields",id:"fields",children:[{value:"<code>request_map</code>",id:"request_map",children:[]},{value:"<code>processors</code>",id:"processors",children:[]},{value:"<code>result_map</code>",id:"result_map",children:[]}]},{value:"Examples",id:"examples",children:[]}],u={toc:p};function b(e){var t=e.components,n=Object(r.a)(e,["components"]);return Object(o.b)("wrapper",Object(a.a)({},u,n,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,"BETA: This component is mostly stable but breaking changes could still be made outside of major version releases if a fundamental problem with the component is found."),Object(o.b)("p",null,"The ",Object(o.b)("inlineCode",{parentName:"p"},"branch")," processor allows you to create a new request message via\na ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"/docs/guides/bloblang/about"}),"Bloblang mapping"),", execute a list of processors\non the request messages, and, finally, map the result back into the source\nmessage using another mapping."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-yaml"}),'# Config fields, showing default values\nbranch:\n  request_map: ""\n  processors: []\n  result_map: ""\n')),Object(o.b)("p",null,"This is useful for preserving the original message contents when using\nprocessors that would otherwise replace the entire contents."),Object(o.b)("h3",{id:"metadata"},"Metadata"),Object(o.b)("p",null,"Metadata fields that are added to messages during branch processing will not be\nautomatically copied into the resulting message. In order to do this you should\nexplicitly declare in your ",Object(o.b)("inlineCode",{parentName:"p"},"result_map")," either a wholesale copy with\n",Object(o.b)("inlineCode",{parentName:"p"},"meta = meta()"),", or selective copies with\n",Object(o.b)("inlineCode",{parentName:"p"},'meta foo = meta("bar")')," and so on."),Object(o.b)("h3",{id:"error-handling"},"Error Handling"),Object(o.b)("p",null,"If the ",Object(o.b)("inlineCode",{parentName:"p"},"request_map")," fails the child processors will not be executed.\nIf the child processors themselves result in an (uncaught) error then the\n",Object(o.b)("inlineCode",{parentName:"p"},"result_map")," will not be executed. If the ",Object(o.b)("inlineCode",{parentName:"p"},"result_map")," fails\nthe message will remain unchanged. Under any of these conditions standard\n",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"/docs/configuration/error_handling"}),"error handling methods")," can be used in\norder to filter, DLQ or recover the failed messages."),Object(o.b)("h3",{id:"conditional-branching"},"Conditional Branching"),Object(o.b)("p",null,"If the root of your request map is set to ",Object(o.b)("inlineCode",{parentName:"p"},"deleted()")," then the branch\nprocessors are skipped for the given message, this allows you to conditionally\nbranch messages."),Object(o.b)("h2",{id:"fields"},"Fields"),Object(o.b)("h3",{id:"request_map"},Object(o.b)("inlineCode",{parentName:"h3"},"request_map")),Object(o.b)("p",null,"A ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"/docs/guides/bloblang/about"}),"Bloblang mapping")," that describes how to create a request payload suitable for the child processors of this branch. If left empty then the branch will begin with an exact copy of the origin message (including metadata)."),Object(o.b)("p",null,"Type: ",Object(o.b)("inlineCode",{parentName:"p"},"string"),Object(o.b)("br",{parentName:"p"}),"\n","Default: ",Object(o.b)("inlineCode",{parentName:"p"},'""'),"  "),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-yaml"}),'# Examples\n\nrequest_map: |-\n  root = {\n    "id": this.doc.id,\n    "content": this.doc.body.text\n  }\n\nrequest_map: |-\n  root = if this.type == "foo" {\n    this.foo.request\n  } else {\n    deleted()\n  }\n')),Object(o.b)("h3",{id:"processors"},Object(o.b)("inlineCode",{parentName:"h3"},"processors")),Object(o.b)("p",null,"A list of processors to apply to mapped requests. When processing message batches the resulting batch must match the size and ordering of the input batch, therefore filtering, grouping should not be performed within these processors."),Object(o.b)("p",null,"Type: ",Object(o.b)("inlineCode",{parentName:"p"},"array"),Object(o.b)("br",{parentName:"p"}),"\n","Default: ",Object(o.b)("inlineCode",{parentName:"p"},"[]"),"  "),Object(o.b)("h3",{id:"result_map"},Object(o.b)("inlineCode",{parentName:"h3"},"result_map")),Object(o.b)("p",null,"A ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"/docs/guides/bloblang/about"}),"Bloblang mapping")," that describes how the resulting messages from branched processing should be mapped back into the original payload. If left empty the origin message will remain unchanged  (including metadata)."),Object(o.b)("p",null,"Type: ",Object(o.b)("inlineCode",{parentName:"p"},"string"),Object(o.b)("br",{parentName:"p"}),"\n","Default: ",Object(o.b)("inlineCode",{parentName:"p"},'""'),"  "),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-yaml"}),'# Examples\n\nresult_map: |-\n  meta foo_code = meta("code")\n  root.foo_result = this\n\nresult_map: |-\n  meta = meta()\n  root.bar.body = this.body\n  root.bar.id = this.user.id\n\nresult_map: |-\n  root.enrichments.foo = if errored() {\n    throw(error())\n  } else {\n    this\n  }\n')),Object(o.b)("h2",{id:"examples"},"Examples"),Object(o.b)(s.a,{defaultValue:"HTTP Request",values:[{label:"HTTP Request",value:"HTTP Request"},{label:"Lambda Function",value:"Lambda Function"},{label:"Conditional Caching",value:"Conditional Caching"}],mdxType:"Tabs"},Object(o.b)(i.a,{value:"HTTP Request",mdxType:"TabItem"},Object(o.b)("p",null,"This example strips the request message into an empty body, grabs an HTTP\npayload, and places the result back into the original message at the path\n",Object(o.b)("inlineCode",{parentName:"p"},"repo.status"),":"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-yaml"}),"pipeline:\n  processors:\n    - branch:\n        request_map: 'root = \"\"'\n        processors:\n          - http:\n              url: https://hub.docker.com/v2/repositories/jeffail/benthos\n              verb: GET\n        result_map: root.repo.status = this\n"))),Object(o.b)(i.a,{value:"Lambda Function",mdxType:"TabItem"},Object(o.b)("p",null,"This example maps a new payload for triggering a lambda function with an ID and\nusername from the original message, and the result of the lambda is discarded,\nmeaning the original message is unchanged."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-yaml"}),'pipeline:\n  processors:\n    - branch:\n        request_map: \'{"id":this.doc.id,"username":this.user.name}\'\n        processors:\n          - lambda:\n              function: trigger_user_update\n'))),Object(o.b)(i.a,{value:"Conditional Caching",mdxType:"TabItem"},Object(o.b)("p",null,"This example caches a document by a message ID only when the type of the\ndocument is a foo:"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-yaml"}),'pipeline:\n  processors:\n    - branch:\n        request_map: |\n          meta id = this.id\n          root = if this.type == "foo" {\n            this.document\n          } else {\n            deleted()\n          }\n        processors:\n          - cache:\n              resource: TODO\n              operator: set\n              key: ${! meta("id") }\n              value: ${! content() }\n')))))}b.isMDXComponent=!0},411:function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return m}));var a=n(0),r=n.n(a);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=r.a.createContext({}),p=function(e){var t=r.a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=p(e.components);return r.a.createElement(l.Provider,{value:t},e.children)},b={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},d=r.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),u=p(n),d=a,m=u["".concat(s,".").concat(d)]||u[d]||b[d]||o;return n?r.a.createElement(m,i(i({ref:t},l),{},{components:n})):r.a.createElement(m,i({ref:t},l))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,s=new Array(o);s[0]=d;var i={};for(var c in t)hasOwnProperty.call(t,c)&&(i[c]=t[c]);i.originalType=e,i.mdxType="string"==typeof e?e:a,s[1]=i;for(var l=2;l<o;l++)s[l]=n[l];return r.a.createElement.apply(null,s)}return r.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},412:function(e,t,n){"use strict";function a(e){var t,n,r="";if("string"==typeof e||"number"==typeof e)r+=e;else if("object"==typeof e)if(Array.isArray(e))for(t=0;t<e.length;t++)e[t]&&(n=a(e[t]))&&(r&&(r+=" "),r+=n);else for(t in e)e[t]&&(r&&(r+=" "),r+=t);return r}t.a=function(){for(var e,t,n=0,r="";n<arguments.length;)(e=arguments[n++])&&(t=a(e))&&(r&&(r+=" "),r+=t);return r}},413:function(e,t,n){"use strict";var a=n(0),r=n(414);t.a=function(){var e=Object(a.useContext)(r.a);if(null==e)throw new Error("`useUserPreferencesContext` is used outside of `Layout` Component.");return e}},414:function(e,t,n){"use strict";var a=n(0),r=Object(a.createContext)(void 0);t.a=r},415:function(e,t,n){"use strict";var a=n(0),r=n.n(a),o=n(413),s=n(412),i=n(56),c=n.n(i),l=37,p=39;t.a=function(e){var t=e.lazy,n=e.block,i=e.defaultValue,u=e.values,b=e.groupId,d=e.className,m=Object(o.a)(),h=m.tabGroupChoices,f=m.setTabGroupChoices,g=Object(a.useState)(i),O=g[0],j=g[1],y=a.Children.toArray(e.children);if(null!=b){var v=h[b];null!=v&&v!==O&&u.some((function(e){return e.value===v}))&&j(v)}var w=function(e){j(e),null!=b&&f(b,e)},N=[];return r.a.createElement("div",null,r.a.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:Object(s.a)("tabs",{"tabs--block":n},d)},u.map((function(e){var t=e.value,n=e.label;return r.a.createElement("li",{role:"tab",tabIndex:0,"aria-selected":O===t,className:Object(s.a)("tabs__item",c.a.tabItem,{"tabs__item--active":O===t}),key:t,ref:function(e){return N.push(e)},onKeyDown:function(e){!function(e,t,n){switch(n.keyCode){case p:!function(e,t){var n=e.indexOf(t)+1;e[n]?e[n].focus():e[0].focus()}(e,t);break;case l:!function(e,t){var n=e.indexOf(t)-1;e[n]?e[n].focus():e[e.length-1].focus()}(e,t)}}(N,e.target,e)},onFocus:function(){return w(t)},onClick:function(){w(t)}},n)}))),t?Object(a.cloneElement)(y.filter((function(e){return e.props.value===O}))[0],{className:"margin-vert--md"}):r.a.createElement("div",{className:"margin-vert--md"},y.map((function(e,t){return Object(a.cloneElement)(e,{key:t,hidden:e.props.value!==O})}))))}},416:function(e,t,n){"use strict";var a=n(3),r=n(0),o=n.n(r);t.a=function(e){var t=e.children,n=e.hidden,r=e.className;return o.a.createElement("div",Object(a.a)({role:"tabpanel"},{hidden:n,className:r}),t)}}}]);